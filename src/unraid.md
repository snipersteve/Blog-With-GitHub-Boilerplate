---
layout: post
title: 科学整合
slug: unraid
date: 2020/11/3 14:26:00
author: ste
---

家里一直是一台群晖加一台N1的组合，前者负责存储并跑一些服务，后者跑PT并跑了一个OP旁路，挺科学，也很稳定。然而不知从什么时候起，反复听到Unraid这个系统，心里开始痒痒也想要搞All in one。但我其实不太确定是否可靠，打算体验一下unraid先，于是买了一台J4125的小主机，8+256的配置，计划就是当个小服务器跑跑；最不济，刷成软路由也行。
![GK55](./images/GK55.jpg)

很小巧的机子，unraid安装也非常简单，单纯把文件拷进U盘即可。上手后发现硬盘组阵列也很简单，而且很自由，设置也很丰富，比如服务类的存储都限定在固态上，而把媒体类限定在机械上，无访问的情况下硬盘自动休眠，最大程度上保护硬盘及省电。这大约是Unraid相较于群晖类跑raid模式的最大优势吧，也是其名字的由来。实测如果某块硬盘损坏，即使没有校验盘，也只是损失这块硬盘上的内容，于其它资料没关系。不过有的时候丢失部分资料的感觉比丢失全部更糟糕，玩unraid还是得上校验才好。上校验又回涉及读写速度慢的问题，最好配缓存，还是挺麻烦的。我暂一块单SSD用着，一般也不容易坏。
![文件逻辑](./images/files.png)

阵列启动后，先开始玩docker，有个app市场，本质上是docker模板以及一些plugins的合集，用起来很方便。市场上没有的，就按传统方法装docker。docker装好后管理起来非常方便，随意编辑修改，一键更新，操作更人性化，特别适合我这种docker党。这个要打满分。
![Docker更新](./images/docker-update.png)

插件的更新也是一样，这些插件都挺实用的，不过能集成到系统就更好了，比如APP市场、存储挂载等，内置更合理。
![插件更新](./images/update.png)

然后玩虚拟机，装了一个黑群试试，也非常简单。不过群晖里比较出彩的几个套件大概也就Drive、Moments、Cloudsync等，其它都不如直接跑docker。由于家里那台群晖还在正常跑着，于是转手又删了。以后可以考虑把家庭照片、个人资料等重要文件存到这台机器的固态上来，更安全；同时跑onedrive云备份，确保万无一失。

本还想再装个centos虚拟机，远程调试rsshub用。后来一想unraid本身就是linux，不如直接在底层跑。于是在Nerd Tools里一键安装了git，并把自己的仓库拉下来。然后跑了一个rsshub的docker，并把路径指好，就算是部署好了调试环境：vscode远程连过去编写路由，然后通过重启docker并看log的方式来调试，一种偷懒的办法。
![dashboard](./images/unraid.png)

如果只是跑这些docker未免有些性能浪费，于是又想起Plex来。同样用docker安装了一个，并挂载了群晖的一个媒体盘作为其媒体库。由于themoviedb等数据库都被墙了，所以必须有前置的科学上网。事实上，unraid使用最好有前置代理，否则app市场都打不开，docker部署也麻烦。不过实测走代理后，本地plex与plex服务器连接存在问题，我在openclash上设置了DOMAIN-KEYWORD,plex,DIRECT，避免向plex服务器错误汇报代理的IP。设置好后连接正常，影片及剧的信息都识别很准，即便不观影，光看看海报墙也是舒服的。
![PLEX](./images/plex.png)

然而J4125的硬解我一直有问题，据称是Intel的BUG还没修。实测CPU软解的话，CPU爆炸，勉强也能播放。为避免转码，可以把烧录字幕的选项设置为仅图像，这样可以避免对ASS字幕转码，降低CPU负担，但ASS的特效也就没了，成为普普通通的字幕。还是不甘心，在网上找了好多好多资料，最终终于解决，要求：1、指定i965驱动；2、关闭VT-d；后者是无意间在smzdm的评论中找到的方案，这是一个神奇的网站。

实现硬解之后，实测在播放前还是有几秒的等待时间，但播放过程中是流畅无卡顿的。总体来说，其观影效果很棒，APP胜Jellyfin等十余条街，比Kodi的体验也好很多。为了Plex硬解，这块CPU真是太心累了，早知道直接上i3 8100之类就会简单很多，忧伤。但是，因为关闭了VT-d，CPU的直通功能也就没了，IOMMU也显示禁用，如果想要直通网卡等进行软路由设定的，就必须有个取舍。我纠结了半天，还是打开了VT-d。
![硬解](./images/HWEC.png)

最终还是在群晖上跑Plex，通过改hosts来解决tmdb无法访问的问题。Plex在1.20.4.3517版更新后，终于提供了为电视剧库指定用tmdb获取信息的功能，而非原先默认的tvdb。themoviedb听起来是针对电影的，实际上电视剧信息也很全，比tvdb更好，基本可以全自动识别不用纠正。Plex相较于Jellyfin的一大优势就是刮削更好用，即便都是指向同样的数据库。

由于我的黑群CPU太弱鸡，转码基本都是转圈，而Plex原生播放器的能直接串流播放的又相当有限。最后我还是选择在CoreElec上跑了Plex插件，并设置为自启动。实测整体启动时间和我小米电视的启动时间相当，体验还可以。什么时候安卓上有个Infuse就好了，Plex真是个让人纠结的东西，但我试了一圈，对于个人影音管理，还是这个最靠谱。

我这台unraid最终成了一个docker专用机。理论上可以把实体群晖淘汰掉，把影片服务、文档备份、照片共享及其它服务都跑在这个机器上，但我认为把所有东西都整合到一起并不是个很好的主意。比如路由的部分，我更倾向于独立出来，用一个ubnt er-x当主路由，安安稳稳，不掉链子。家里的实体黑群既然还能正常用，索性就继续用着，也还不错。所以说了半天整合，其实我压根没有整合，反而多了个设备。通过功能的划分，我觉得总体还是更合理了。
