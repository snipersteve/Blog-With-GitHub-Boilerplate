---
layout: post
title: 科学订阅
slug: rss
date: 2020/1/4 20:26:00
author: ste
---

十年前是RSS盛行的年代，十年后已变成了微信公众号的天下。微信公众号给出了一种比较简便的内容发布方案，但是不够开放，算是进步和退步吧。2019年8、9月份的时候，因为需要跟踪上海发改委网站上关于奉贤海上风电项目竞价的情况，每天打开网站看一遍，真是太蛋疼了。于是想到了自己去烧制一个RSS。

通过Google找到了Feed43，原理蛮简单，就是定时去读取网站内容，然后用类似正则的方式去匹配内容信息。试了一下就会了，制作了国家发改委、能源局等网站的RSS。
![Feed43](./images/feed43.png)

然后把这个feed丢到任何一个RSS阅读器即完成订阅。完工。

---

不过折腾总是不会这么快结束，还想要在手机上也能方便得收到实时推送。然而现在RSS式微，iOS上尚有不少优秀app，安卓上都找不到合适的。转而想到Telegram，果然有人提供rss bot可以直接用。在对话框中告诉机器人要订阅的rss链接，机器人就会在有更新时推送消息给你，轻量而且方便。不过由于是第三方的bot，用了没几天就因服务器问题下线了，所以还是得自己动手。顺着这个bot找到了源码，是一个go语言写的开源机器人：flowerss-bot。

为了跑这个服务，把家里吃灰的N1拿出来刷成了armbian。这台N1原本是刷了coreelec看片用，后来换Plex就用不上了。U盘刷完armbian后引导启动成功，再写入emmc。因为有前人经验，dtb什么的都搞好了，所以这一步很顺利。
![armbian](./images/armbian.jpg)

然后打算跑这个服务，但作者并没有提供arm版的程序，只能自己编译。先装了go，然后go build。
![flowerss](./images/flowerss.jpg)

终于跑起来了，然后为了配置数据库的原因折腾了一下，最后发现不配置就可以运行。成功运行后，在Telegram上用/sub命令就可以订阅，效果如下：
![Telegram](./images/telegram.jpg)

不过，还是想要群晖Docker那种可视化操作界面，于是继续装上Docker，并弄好图形界面。
![Portainer](./images/portainer.jpg)

把flowerss的官方docker镜像拉下来发现，这个docker也不支持arm框架。于是继续在arm环境下运行dockerfile打包为docker镜像。这个命令是"docker build ."，我因为少打了一个"."，折腾了很久。

这毕竟是我第一次打包docker镜像，也没有换源啥的，试了好多次，终于成功了。
![Docker build](./images/docker-build.png)

然后在Portaner里新建一个容器，成功跑起来了。这样就可以方便地查看日志以及远程访问了。
![Docker run](./images/docker-run.png)

---

然而在看日志的时候发现，Feed43的源因为稳定性问题经常抓不到xml，而且其本身限制6小时抓一次，也不够及时。于是转而又找到一个叫RssHub的项目，也可以Docker运行，跑在自己的服务器上更放心。不过这个工具就没有那么简便的可视化规则编辑界面了，需要用js语言自己写“路由”。我本想找一个路由规则抄抄，但由于完全不懂js，始终不成功。最后还是要感谢毛总帮我写了规则，我在旁边看得一脸蒙蔽。
![路由规则](./images/router.png)

毛总用一个中午的时间帮我实现了国家发改委网站的抓取，并在调试后优化。抓取的内容如图：
![feed](./images/feed.png)

我尝试在脱离毛总支持的情况下自己写路由，一直不成功。这个工具的门槛还是偏高，我暂时驾驭不了，或许是我学习js和git的一条进路。对于已有的路由，体验还是很好的。比如这个写好全文规则的路由，配合flowerss，可以把原文转存的Telegraph，看起来很方便。
![全文](./images/full-text.jpg)

---

转而找到另一个工具huginn，直接跑Docker，有可视化界面，通过指定xpath路径实现内容抓取，编写规则和测试都简单很多。我试着写了规则，很快就抓到内容了。
![huginn](./images/huginn.png)

然而，这里抓取的链接并不完整，还需要拼接上网址前缀；但又偏偏多了一个点，很难处理。于是还是得靠毛总帮忙，终于把那个点去掉了。
![agent rule](./images/agent.png)

这还只是抓取列表的agent，还需要再另建一个抓取全文的agent和生成rss的agent，有点麻烦。这东西看起来简单，但实际实现起来还是不易，可能还不如RssHub。折腾了半天可能还是Feed43最适合我，时效性和稳定性上虽然会略差一点，但是影响不大（又不是不能用）。

---

为了能让别人也能看到这些订阅结果，又另新建一个频道，并把bot加进去，由bot来推送信息。
![频道](./images/channel.png)

这个rssbot实在是太好用，非常喜欢，于是决定拿群晖再跑一个公开用。然而由于官方镜像有点问题，没跑成功，于是用dockerhub在线编译了一个。
![dockerhub](./images/dockerhub.png)

可以拿这个镜像自己跑，也可以直接用[这个](https://t.me/new_rss_bot)现成的，但长期可用性不作保证。

---

搞了这么多东西，只是为了在第一时间可以了解到这些网站的最新政策动向，希望对工作会有帮助。这次折腾的附带体会是，Docker真好用，很多原本商业化的服务，现在也可以很简单地在自己的服务器上跑了；服务器也未必一定是个大家伙，像N1这样的小盒子，甚至是更小的pi，都可以当很不错的轻量服务器；portainer这个容器管理界面我也很喜欢，比群晖那个更灵活，配置更丰富，远程访问也更为方便。
![容器](./images/containers.jpg)

完结撒花。